<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.cdnfonts.com/css/varuna" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./profile.css">
    <title>Profile page</title>
</head>

<body>
    <h1>Your profile</h1>
    <div class="profile-box">
        <img id="profileImage" style="display:none;" alt="Profile Picture">
        <button id="editPhotoBtn"><i class="fa-solid fa-pencil"></i></button>
        <input type="file" id="editPhotoInput" accept="image/*" style="display:none;">
    </div>
    <h2>Welcome, <span id="profileUsername"></span>!</h2>

    <div id="cropModal" style="display:none; position:fixed; top:0; left:0; 
        width:100%; height:100%; background:rgba(0,0,0,0.8); 
        justify-content:center; align-items:center; z-index:1000;">
        <div style="background:#fff; padding:20px; border-radius:10px; text-align:center;">
            <h3>Adjust your photo</h3>
            <img id="cropImage" style="max-width:300px; max-height:300px;">
            <br><br>
            <button id="saveCrop">Save</button>
            <button id="cancelCrop">Cancel</button>
        </div>
    </div>
    <button id="logoutBtn">Log Out</button>
    <a href="./index.html" class="backBtn">Back</a>

    <script src="./auth.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));

        if (!currentUser) {
            window.location.href = "./login.html";
        } else {
            document.getElementById("profileUsername").textContent = currentUser.username;
            if (currentUser.profilePic) {
                const img = document.getElementById("profileImage");
                img.src = currentUser.profilePic;
                img.style.display = "block";
            }
        }
        document.addEventListener("DOMContentLoaded", () => {
            const profileImg = document.getElementById("profileImage");
            const profileUsername = document.getElementById("profileUsername");
            const editBtn = document.getElementById("editPhotoBtn");
            const editInput = document.getElementById("editPhotoInput");
            const cropModal = document.getElementById("cropModal");
            const cropImage = document.getElementById("cropImage");
            const saveCrop = document.getElementById("saveCrop");
            const cancelCrop = document.getElementById("cancelCrop");
            let cropper;
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                window.location.href = "./login.html";
                return;
            }
            profileUsername.textContent = currentUser.username;
            if (currentUser.profilePic) {
                profileImg.src = currentUser.profilePic;
                profileImg.style.display = "block";
            }
            editBtn.addEventListener("click", () => editInput.click());

            editInput.addEventListener("click", (e) => e.stopPropagation()); 

            editInput.addEventListener("change", function () {
                const file = this.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    cropImage.src = e.target.result;
                    cropModal.style.display = "flex";

                    if (cropper) cropper.destroy();

                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        zoomable: true,
                        scalable: true,
                        movable: true,
                    });
                };
                reader.readAsDataURL(file);
            });



            saveCrop.addEventListener("click", () => {
                const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
                const croppedImage = canvas.toDataURL("image/png");

                profileImg.src = croppedImage;
                profileImg.style.display = "block";

                currentUser.profilePic = croppedImage;
                localStorage.setItem("currentUser", JSON.stringify(currentUser));
                const users = JSON.parse(localStorage.getItem("users")) || [];
                const index = users.findIndex(u => u.username === currentUser.username);
                if (index > -1) {
                    users[index].profilePic = croppedImage;
                    localStorage.setItem("users", JSON.stringify(users));
                }

                cropModal.style.display = "none";
                cropper.destroy();
            });

            cancelCrop.addEventListener("click", () => {
                cropModal.style.display = "none";
                if (cropper) cropper.destroy();
            });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</body>

</html>